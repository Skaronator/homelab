name: Verify Helm Charts
on:
  push:

jobs:
  build-image:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0

    - name: Login to image repository
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3.0.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract Docker metadata
      id: meta
      uses: docker/metadata-action@v5.0.0
      with:
        images: ghcr.io/${{ github.repository }}
        tags: |
          type=sha

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3.0.0

    - name: Build and push Docker image
      uses: docker/build-push-action@v4.2.1
      with:
        context: .github
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

    outputs:
      tag: ${{ steps.meta.outputs.tags }}

  verify-yaml:
    runs-on: ubuntu-22.04
    needs: build-image
    container: docker://${{ needs.build-image.outputs.tag }}
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout repository
      uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0
    - name: Show versions
      run: |
        helm version
        kubeconform -v
        kubectl version --client
    - name: Verify everything
      run: |
        for dir in *; do
            # exclude files and dirs that start with a . (dot)
            if [[ -d "$dir" && ! "$dir" =~ /\\.[^.]/ ]]; then
                echo "Processing directory: $dir"
                for chart in $dir/*; do
                    echo "Processing chart: $chart"
                    kubectl kustomize $chart --enable-helm | kubeconform -ignore-missing-schemas -strict -summary
                done
            fi
        done
